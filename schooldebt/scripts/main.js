!function(){for(var t=0,e=["ms","moz","webkit","o"],a=0;a<e.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[e[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[a]+"CancelAnimationFrame"]||window[e[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var a=(new Date).getTime(),n=Math.max(0,16-(a-t)),i=window.setTimeout(function(){e(a+n)},n);return t=a+n,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),+function(t){"use strict";function e(e){e&&3===e.which||(t(i).remove(),t(s).each(function(){var n=t(this),i=a(n),s={relatedTarget:this};i.hasClass("open")&&(i.trigger(e=t.Event("hide.bs.dropdown",s)),e.isDefaultPrevented()||(n.attr("aria-expanded","false"),i.removeClass("open").trigger("hidden.bs.dropdown",s)))}))}function a(e){var a=e.attr("data-target");a||(a=e.attr("href"),a=a&&/#[A-Za-z]/.test(a)&&a.replace(/.*(?=#[^\s]*$)/,""));var n=a&&t(a);return n&&n.length?n:e.parent()}function n(e){return this.each(function(){var a=t(this),n=a.data("bs.dropdown");n||a.data("bs.dropdown",n=new r(this)),"string"==typeof e&&n[e].call(a)})}var i=".dropdown-backdrop",s='[data-toggle="dropdown"]',r=function(e){t(e).on("click.bs.dropdown",this.toggle)};r.VERSION="3.3.1",r.prototype.toggle=function(n){var i=t(this);if(!i.is(".disabled, :disabled")){var s=a(i),r=s.hasClass("open");if(e(),!r){"ontouchstart"in document.documentElement&&!s.closest(".navbar-nav").length&&t('<div class="dropdown-backdrop"/>').insertAfter(t(this)).on("click",e);var l={relatedTarget:this};if(s.trigger(n=t.Event("show.bs.dropdown",l)),n.isDefaultPrevented())return;i.trigger("focus").attr("aria-expanded","true"),s.toggleClass("open").trigger("shown.bs.dropdown",l)}return!1}},r.prototype.keydown=function(e){if(/(38|40|27|32)/.test(e.which)&&!/input|textarea/i.test(e.target.tagName)){var n=t(this);if(e.preventDefault(),e.stopPropagation(),!n.is(".disabled, :disabled")){var i=a(n),r=i.hasClass("open");if(!r&&27!=e.which||r&&27==e.which)return 27==e.which&&i.find(s).trigger("focus"),n.trigger("click");var l=" li:not(.divider):visible a",o=i.find('[role="menu"]'+l+', [role="listbox"]'+l);if(o.length){var d=o.index(e.target);38==e.which&&d>0&&d--,40==e.which&&d<o.length-1&&d++,~d||(d=0),o.eq(d).trigger("focus")}}}};var l=t.fn.dropdown;t.fn.dropdown=n,t.fn.dropdown.Constructor=r,t.fn.dropdown.noConflict=function(){return t.fn.dropdown=l,this},t(document).on("click.bs.dropdown.data-api",e).on("click.bs.dropdown.data-api",".dropdown form",function(t){t.stopPropagation()}).on("click.bs.dropdown.data-api",s,r.prototype.toggle).on("keydown.bs.dropdown.data-api",s,r.prototype.keydown).on("keydown.bs.dropdown.data-api",'[role="menu"]',r.prototype.keydown).on("keydown.bs.dropdown.data-api",'[role="listbox"]',r.prototype.keydown)}(jQuery),function(){"use strict";function t(t){var e,a=Math.round(t/1e6),n=String(a);for(e=n.length-3;e>0;e-=3)n=n.slice(0,e)+","+n.slice(e,n.length);return"$"+n+" million"}var e,a,n,i,s,r,l="data/data.json",o="data/us-states.json";$(function(){$.ajax({url:l,dataType:"json",success:e.initialize})}),e={data:{},mapData:{},components:{controls:{},compare:{},bars:{}},globals:{available:{years:[],states:[]},selected:{year:null,state:null},view:null,animating:!1},initialize:function(t){$("#loading").fadeOut(),$("#main").fadeIn(),e.data=t,e.mapData=s.getData(),e.globals.available.years=_.pluck(t.VALUES,"YEAR"),e.globals.available.states=_.pluck(t.STATES,"STATE"),e.globals.selected.year=_.last(e.globals.available.years),e.globals.selected.state="All States",e.globals.view="LineChart",e.components.controls=new a("#controls",e),e.components.compare=new i("#compare",e),e.components.bars=new r("#bars",e),$(window).resize(function(){e.components.compare.draw(),e.components.bars.draw()}),$(document).keydown(function(t){if("LineChart"===e.globals.view){switch(t.which){case 37:e.shiftYear(!0);break;case 39:e.shiftYear();break;default:return}t.preventDefault()}})},updateSelected:function(t,a,n){e.globals.selected[t]=a,n||e.toggleAnimation(!0),_.each(e.components,function(e){e.update(t,a)})},shiftYear:function(t,a){var n=e.globals.available.years,i=e.globals.selected.year,s=_.findIndex(n,function(t){return t===i}),r=t?n[0===s?n.length-1:s-1]:n[s===n.length-1?0:s+1];e.updateSelected("year",r,a)},highlight:function(t,a,n){_.each(e.components,function(t){t.highlight&&t.highlight(a,n)}),"state"===a&&e.displayTooltip(t,n)},displayTooltip:function(a,n){if(n&&!e.globals.animating){var i,s,r,l,o,d,c,h,u,p={},f={width:400,height:121},g=$(a),m=e.globals.selected,w=m.year,v=m.state,b="All States"===v;if(b){if(s=_.find(e.data.STATES,{STATE:n}),!s)return;l=_.find(s.VALUES,{YEAR:w}),o=n}else{if(r=_.find(e.data.STATES,{STATE:v}),s=_.find(r.LEAS,{ID:n}),!s)return;l=_.find(s.VALUES,{YEAR:w}),o=s.NAME}d=l.TOTALREV,c=l.TOTALDEBT,h=g.offset(),u=h.left>$(window).width()/2,p.left=u?h.left-f.width-3:h.left+30,p.top=h.top-f.height-4,i=$("#tooltip"),i.css({left:p.left,top:p.top,width:f.width,height:f.height}).toggleClass("left-side",u),i.find(".name").text(o),i.find(".revenue").text(t(d)),i.find(".debt").text(t(c)),i.find(".percentage").text(Math.round(c/d*100)+"%"),i.show()}else $("#tooltip").hide()},toggleAnimation:function(t){function a(t){if(e.globals.animating){n||(e.shiftYear(!1,!0),n=t);var i=t-n;500>=i?window.requestAnimationFrame(a):(n=null,window.requestAnimationFrame(a))}}var n=null,i=$("#animate");e.globals.animating||t?(e.globals.animating=!1,i.removeClass("playing"),i.addClass("paused"),$("body").removeClass("animating")):(e.globals.animating=!0,window.requestAnimationFrame(a),i.removeClass("paused"),i.addClass("playing"),$("body").addClass("animating"))},toggleView:function(t){if(e.globals.view!==t){switch($("#compare").children().remove(),t){case"LineChart":e.components.compare=new i("#compare",e);break;case"Map":e.components.compare=new s("#compare",e)}e.globals.view=t}}},a=function(t,e){function a(t){if(t.preventDefault(),0===$(t.target).parents(".dropdown").length){var a=$(t.currentTarget),n=a.data("view");a.siblings().removeClass("selected"),a.addClass("selected"),e.toggleView(n)}}function n(t){$(t.target).hasClass("disabled")||e.toggleAnimation()}this.owner=e,this.$el=$(t),this.populateMenus(),this.$el.children(".selector").click(a),this.$el.find("#animate").click(n)},a.prototype.populateMenus=function(){function t(t,e){_.each(e,function(e){t.append($("<li>").append($("<a>").attr({role:"menuitem",href:"#"}).text(e)))})}function e(t){var e=$(this).data("type"),n=$(t.target).text();t.preventDefault(),a.updateSelected(e,n)}var a=this.owner,n=a.globals.available,i=_.clone(n.years).reverse(),s=n.states,r=i[0],l=this.$el.find("#year-selector .dropdown-menu"),o=this.$el.find("#state-selector .dropdown-menu");l.children().remove(),t(l,i),l.find("li:first-child a").addClass("selected"),this.$el.find("#year-button span.text").text(r),l.click(e),o.children().remove(),t(o,s),o.prepend($('<li><a role="menuitem" href="#" class="selected">All States</a></li>')),this.$el.find("#state-button span.text").text("All States"),o.click(e)},a.prototype.update=function(t,e){var a=this.$el.find("#"+t+"-selector .dropdown"),n=a.children(".dropdown-menu");n.find("a").removeClass("selected"),n.find("a:contains("+e+")").addClass("selected"),a.find("button span.text").text(e),"state"===t&&("All States"===e?$("#animate").removeClass("disabled"):$("#animate").addClass("disabled"))},n=function(t,e){this.owner=e,this.$el=$(t),this.svg=d3.select(t).append("svg").classed(this.classed,!0),this.$el.append(this.title),this.draw()},n.create=function(t){var e=this,a=function(){e.apply(this,arguments)};return a.prototype=_.create(e.prototype,t),a},n.prototype={classed:"exhibit",title:$("<h2>Exhibit</h2>"),drawBackground:function(){},drawData:function(){},updateYear:function(){},updateState:function(){},updateTitle:function(){var t=this.owner.globals.selected,e=t.year,a=t.state,n="All States"===a?"":a;this.title.children("span.replace.year").text(e),this.title.children("span.replace.state").text(n)},draw:function(){this.drawBackground(),this.drawData(),this.updateYear(!0),this.updateState(!0),this.updateTitle()},update:function(t){switch(t){case"year":this.updateYear();break;case"state":this.updateState()}this.updateTitle()}},i=n.create({classed:"line-chart",title:$('<h2><span class="replace state"></span> debt as a share of annual revenue</h2>'),drawBackground:function(){function t(t){var e,a=c>400?2:4,n=t.length%a-1,i=[];for(e=n;e<t.length;e+=a)i.push(t[e]);return i}var e,a,n,i,s,r=this.owner,l=r.globals,o=this.svg,d={top:22,right:30,bottom:76,left:50},c=this.$el.width()-d.left-d.right,h=this.$el.height()-d.top-d.bottom;o.attr("width",c+d.left+d.right).attr("height",h+d.top+d.bottom),this.width=c,this.height=h,o.select("g.canvas").remove(),s=o.append("g").classed("canvas",!0).attr("transform","translate("+d.left+","+d.top+")"),e=d3.scale.ordinal().rangeBands([0,c],0,.5).domain(l.available.years),a=d3.scale.linear().range([h,0]).domain([0,1]),this.x=e,this.y=a,n=d3.svg.axis().scale(e).orient("bottom").tickValues(t(l.available.years)),i=d3.svg.axis().scale(a).orient("left").ticks(5).tickFormat(d3.format("%")).tickSize(-c,0,0),this.linePath=d3.svg.line().x(function(t){return e(t.YEAR)+e.rangeBand()/2}).y(function(t){return a(t.TOTALDEBT/t.TOTALREV)}),s.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(n),s.append("g").attr("class","y axis").call(i),this.line=s.append("path").attr("class","line"),s.selectAll(".year").data(l.available.years).enter().append("rect").attr("id",function(t){return"yearrect-"+t}).attr("class","year").attr("x",function(t){return e(t)}).attr("width",e.rangeBand()).attr("y",0).attr("height",h).on("click",function(t){r.updateSelected("year",t)}),this.point=s.append("circle").attr("class","point").attr("r","9px"),this.label=s.append("text").attr("class","label").attr("text-anchor","middle").attr("dy","-1em")},drawData:function(){var t=this.line,e=this.linePath,a=this.owner,n=a.globals.selected.state,i="All States"===n?a.data.VALUES:_.find(a.data.STATES,{STATE:n}).VALUES;t.datum(i).transition().attr("d",e)},drawLabel:function(t){var e=this.x,a=this.y,n=this.point,i=this.label,s=this.owner,r=s.globals.selected,l=s.globals.animating,o=r.state,d=r.year,c=s.globals.available.years,h=_.findIndex(c,function(t){return t===d}),u=0===h,p="All States"===o?s.data.VALUES:_.find(s.data.STATES,{STATE:o}).VALUES,f=_.find(p,{YEAR:d}),g=l?500:t?250:0;l&&u?(n.datum(f).transition().duration(g/2).ease("cubic-in").attr("cx",this.width+100).each("end",function(){d3.select(this).attr("cx",-100).attr("cy",function(t){return a(t.TOTALDEBT/t.TOTALREV)})}).transition().duration(g/2).ease("cubic-out").attr("cx",e(d)+e.rangeBand()/2),i.datum(f).transition().duration(g/2).ease("cubic-in").attr("x",this.width+100).each("end",function(){d3.select(this).attr("x",-100).attr("y",function(t){var e=a(t.TOTALDEBT/t.TOTALREV);return e=10>e?10:e}).text(function(t){return Math.round(t.TOTALDEBT/t.TOTALREV*100)+"%"})}).transition().duration(g/2).ease("cubic-out").attr("x",e(d)+e.rangeBand()/2)):(n.datum(f).transition().duration(g).ease(l?"linear":"cubic-in-out").attr("cx",e(d)+e.rangeBand()/2).attr("cy",function(t){return a(t.TOTALDEBT/t.TOTALREV)}),i.datum(f).transition().duration(g).ease(l?"linear":"cubic-in-out").attr("x",e(d)+e.rangeBand()/2).attr("y",function(t){var e=a(t.TOTALDEBT/t.TOTALREV);return e=10>e?10:e}).each("end",function(){d3.select(this).text(function(t){return Math.round(t.TOTALDEBT/t.TOTALREV*100)+"%"})}))},updateYear:function(){var t=this.owner.globals.selected.year;this.svg.selectAll(".year").classed("selected",!1),this.svg.select("#yearrect-"+t).classed("selected",!0),this.drawLabel()},updateState:function(t){t||(this.drawData(),this.drawLabel(!0))}}),s=n.create({classed:"map",title:$('<h2>debt as a share of annual revenue, <span class="replace year"></span></h2>'),drawBackground:function(){var t=this.owner,e=this.$el,a=this.svg,n={top:50,right:30,bottom:76,left:30},i=this.$el.width()-n.left-n.right,s=this.$el.height()-n.top-n.bottom;a.attr("width",i+n.left+n.right).attr("height",s+n.top+n.bottom),t.mapData.done(function(r){var l,o,d;a.select("g.canvas").remove(),l=a.append("g").classed("canvas",!0).attr("transform","translate("+n.left+","+n.top+")"),o=d3.geo.albersUsa().scale(2*s).translate([i/2,s/2]),d=d3.geo.path().projection(o),l.selectAll("path").data(r.features).enter().append("path").attr("title",function(t){return t.properties.NAME}).attr("d",d).on("click",function(e){t.highlight(this,"state",void 0),t.updateSelected("state",e.properties.NAME)}).on("mouseover",function(e){"All States"===t.globals.selected.state&&t.highlight(this,"state",e.properties.NAME)}).on("mouseout",function(){t.highlight(this,"state",void 0)}),e.find("svg").click(function(e){t.globals.animating||"All States"===t.globals.selected.state||"path"===e.target.nodeName||t.updateSelected("state","All States")})})},drawData:function(){var t=this.owner,e={0:"#999",1:"#978188",2:"#946a78",3:"#925167",4:"#903956",5:"#8d2145",6:"#8b0a35"},a=d3.scale.quantize().domain([.4,1.1]).range(d3.range(7).map(function(t){return e[t]})),n=t.globals.animating?500:0;this.svg.selectAll("path").transition().duration(n).style("fill",function(e){var n=e.properties.NAME,i=t.globals.selected.year,s=_.find(_.find(t.data.STATES,{STATE:n}).VALUES,{YEAR:i});return a(s.TOTALDEBT/s.TOTALREV)})},updateYear:function(t){t||this.drawData()},updateState:function(){var t=this.svg.selectAll("path"),e=this.owner.globals.selected.state;t.classed("highlighted",!1),"All States"===e?this.svg.classed("faded",!1):(this.svg.classed("faded",!0),t.each(function(){$(this).attr("title")===e&&d3.select(this).classed("highlighted",!0)}))},highlight:function(t,e){var a=this.svg.selectAll("path");"state"===t&&"All States"===this.owner.globals.selected.state&&(this.svg.classed("faded",e),a.classed("highlighted",!1),e&&a.each(function(){$(this).attr("title")===e&&d3.select(this).classed("highlighted",!0)}))}}),s.getData=function(){return $.ajax({url:o,dataType:"json"})},r=n.create({classed:"bar-treemap",title:$('<h2><span class="replace state"></span> revenue and debt totals, <span class="replace year"></span></h2>'),series:{TOTALREV:"Annual Revenue",TOTALDEBT:"Outstanding Debt"},drawBackground:function(){var t,e,a,n,i,s=this.owner,r=this.$el,l=this.svg,o=this.series,d={top:50,right:30,bottom:76,left:30},c=this.$el.width()-d.left-d.right,h=this.$el.height()-d.top-d.bottom;this.margin=d,this.width=c,this.height=h,l.attr("width",c+d.left+d.right).attr("height",h+d.top+d.bottom),l.select("g.canvas").remove(),i=l.append("g").classed("canvas",!0).attr("transform","translate("+d.left+","+d.top+")"),t=d3.scale.ordinal().rangeBands([0,c],.5,.25).domain(_.keys(o)),e=d3.scale.linear().range([h,0]),this.x=t,this.y=e,a=d3.svg.axis().scale(t).orient("bottom").tickFormat(function(t){return o[t]}),n=d3.svg.axis().scale(e).orient("left").ticks(1).tickSize(-c,0,0),i.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(a),i.append("g").attr("class","y axis").call(n),this.canvas=i,r.find("svg").click(function(t){s.globals.animating||"All States"===s.globals.selected.state||"rect"===t.target.nodeName||s.updateSelected("state","All States")})},drawData:function(a){function n(){var t=m.selectAll("g.series").data(f);return t.enter().append("g").attr("class",function(t){return"series "+t.key}).each(function(t){d3.select(this).append("text").datum(t).attr("class","label").attr("text-anchor","middle").attr("dy","-.5em").attr("dx",t.width/2)}),t}function i(t){return t.each(function(t){var e,a=d3.select(this);t.updateYear(y),e=a.selectAll(".node").data(t.treemap.nodes),e.enter().append("rect").attr("class",function(t){return"node"+(0===t.depth?" parent":"")+(S?" state":"")}),e.attr("title",function(t){return S?t.STATE:t.ID}),S&&e.on("click",function(t){b.highlight(this,"state",void 0),b.updateSelected("state",t.STATE)}),e.on("mouseover",function(t){b.highlight(this,"state",S?t.STATE:t.ID)}).on("mouseout",function(){b.highlight(this,"state",void 0)}),e.exit().remove()}),t}function s(t,e){var a={};return t.each(function(t){a[t.key]=_.find(t.children,{STATE:e})}),a}function r(t,e){return t.attr("transform",function(t){return e?"translate("+t.offsetLeft+","+g+") scale(1 0)":"translate("+t.offsetLeft+","+t.offsetTop+")"}),t}function l(t,e){return t.attr("transform",function(t){var a=e[t.key];return"translate("+(a.parent.offsetLeft+a.x)+","+(a.parent.offsetTop+a.y)+") scale("+a.dx/t.dx+" "+a.dy/t.dy+")"}),t}function o(t){return t.selectAll(".node").attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("width",function(t){return t.dx}).attr("height",function(t){return t.dy>0?t.dy:0}),t}function d(e){e.tween?e.selectAll(".label").tween("text",function(e){var a=function(a){var n;return 1!==a&&e.oldValue?n=e.oldValue+(e.value-e.oldValue)*a:(n=e.value,e.oldValue=e.value),t(n)};return function(t){this.textContent=a(t)}}):e.selectAll(".label").text(function(e){return t(e.value)})}var c,h,u,p,f=this.data,g=this.height,m=this.canvas,w=this.x,v=this.y,b=this.owner,A=b.globals.selected,T=A.state,y=A.year,S="All States"===T,E=S?b.data:_.find(b.data.STATES,{STATE:T}),x=S?E.STATES:E.LEAS,$=e.globals.animating,k=a&&S?$?500:250:0;"year"!==a&&(p=_.reduce(E.VALUES,function(t,e){return Math.max(t,e.TOTALREV,e.TOTALDEBT)},0),v.domain([0,p]),f=_.map(this.series,function(t,e){var a=d3.layout.treemap().sticky(S).ratio(2),n=_.map(x,function(t){return _.clone(t)});return{key:e,label:t,width:w.rangeBand(),offsetLeft:w(e),children:n,treemap:a,updateYear:function(t){return this.value=_.find(E.VALUES,{YEAR:t})[e],this.offsetTop=v(this.value),this.height=g-this.offsetTop-1,this.treemap.size([this.width,this.height]).value(function(a){var n=_.find(a.VALUES,{YEAR:t}),i=n?n[e]:0;return i}),this}}}),this.data=f),"state"!==a||T===this.last.state?n().call(i).transition().duration(k).ease($?"linear":"cubic-in-out").call(r).call(o).call(d):S?(c=m.selectAll("g.series"),c.classed("series",!1),h=n().call(i).call(r).call(o).call(d).style("opacity",0),u=s(h,this.last.state),c.selectAll(".label").remove(),c.transition().duration(500).call(l,u).remove(),h.transition().duration(500).style("opacity",1)):"All States"===this.last.state?(c=m.selectAll("g.series"),u=s(c,T),c.classed("series",!1).transition().duration(500).style("opacity",0).remove(),n().call(i).call(l,u).call(o).call(d).style("opacity",0).transition().duration(500).call(r).style("opacity",1)):(m.selectAll("g.series").classed("series",!1).transition().duration(500).call(r,!0).style("opacity",0).remove(),n().call(i).call(r,!0).call(o).call(d).transition().duration(500).call(r)),this.last={state:T,year:y}},updateYear:function(t){t||this.drawData("year")},updateState:function(t){t||this.drawData("state")},highlight:function(t,e){var a=this.canvas.selectAll(".node");"state"===t&&(this.svg.classed("faded",e),a.classed("highlighted",!1),e&&a.each(function(){$(this).attr("title")===e&&d3.select(this).classed("highlighted",!0)}))}})}();